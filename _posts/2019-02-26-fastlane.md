---
layout: post
title: "iOSè‡ªåŠ¨æ‰“åŒ…ç¥å™¨fastlaneéƒ¨ç½²"
subtitle: 'å¤štargetæ•ˆç‡ç¥å™¨, è‡ªåŠ¨é’‰é’‰æ¶ˆæ¯æé†’'
author: "lingjye"
header-img: 'img/fastlane/fastlane_text.png'
header-mask: 0.3
tags:
  - iOS
---

## ç®€ä»‹


åŸæ–‡: [fastlane](https://fastlane.tools){:target="_blank"} is the easiest way to automate beta deployments and releases for your iOS and Android apps. ğŸš€ It handles all tedious tasks, like generating screenshots, dealing with code signing, and releasing your application.

[Fastlane](https://fastlane.tools){:target="_blank"} æ˜¯ä¸€å¥—ç”±Rubyå†™æˆçš„è‡ªåŠ¨åŒ–å·¥å…·é›†, å¯ä»¥è‡ªåŠ¨éƒ¨ç½²å’Œå‘å¸ƒ(iOS/å®‰å“)åº”ç”¨, å¯ä»¥è‡ªåŠ¨æ‰§è¡Œç¹ççš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç”Ÿæˆå±å¹•æˆªå›¾, å¤„ç†é…ç½®æ–‡ä»¶å’Œå‘å¸ƒåº”ç”¨ç¨‹åº

**å…¶ä»–å¼€æºæŒç»­æ„å»ºå¹³å°æœ‰:**

[Jekins](https://jenkins.io/){:target="_blank"} éœ€è¦æ­å»ºç¯å¢ƒ, é…ç½®è¿‡ç¨‹æ¯”è¾ƒç¹ç

fir.im åæ¥ä¹Ÿæ¨å‡ºäº†[flow.ci](https://flow.ci/){:target="_blank"}, æ”¯æŒfastlane ç›¸å¯¹æ¯”è¾ƒç®€å•, éœ€è¦ä¾èµ– Docker æœåŠ¡

## å¦‚ä½•ä½¿ç”¨fastlane for iOS

1. å®‰è£…æœ€æ–°çš„Xcodeå‘½ä»¤è¡Œå·¥å…·

	```
	$ xcode-select --install
	```

	å¦‚æœæç¤º:

	> xcode-select: error: command line tools are already installed, use "Software Update" to install updates

	è¡¨ç¤ºå·²å®‰è£…, ç›´æ¥è¿›è¡Œç¬¬äºŒæ­¥

2. å®‰è£…fastlane

	```
	# ä½¿ç”¨ RubyGems å®‰è£…
	$ sudo gem install fastlane -NV
	```
	
	æˆ–è€…
	
	```
	# ä½¿ç”¨ Homebrew å®‰è£…
	$ brew cask install fastlane
	```

3. åˆå§‹åŒ–fastlane
	
	ä½¿ç”¨ç»ˆç«¯å¹¶cdåˆ°é¡¹ç›®è·¯å¾„ä¸‹, ä¾‹å¦‚:
	
	```
	$ cd fastlaneTest
	```
	
	ç„¶åæ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤:
	
	```
	$ fastlane init
	```
	
	ç„¶åä¼šå‡ºç°4ä¸ªé€‰é¡¹:
	
	```
	1. ğŸ“¸  Automate screenshots(è‡ªåŠ¨åŒ–æˆªå›¾)

	
	2. ğŸ‘©â€âœˆï¸  Automate beta distribution to TestFlight(å°†æµ‹è¯•ç‰ˆåˆ†å‘è‡ªåŠ¨åŒ–åˆ°TestFlight)

	
	3. ğŸš€  Automate App Store distribution(è‡ªåŠ¨å‘å¸ƒåˆ°App Store)

	
	4. ğŸ›   Manual setup - manually setup your project to automate your tasks(æ‰‹åŠ¨è®¾ç½® - æ‰‹åŠ¨è®¾ç½®æ‚¨çš„é¡¹ç›®ä½¿å¾—æ‚¨çš„ä»»åŠ¡è‡ªåŠ¨åŒ–)
	```
	
	æ­¤æ—¶, æˆ‘ä»¬é€‰æ‹©ç¬¬4é¡¹, ç­‰å¾… `bundle update` æ‰§è¡Œç»“æŸ, å¹¶è¾“å…¥å›è½¦, ç›´è‡³ç»“æŸ
	
	![init](https://raw.githubusercontent.com/lingjye/lingjye.github.io/master/img/fastlane/fastlane_init.png)
	
	å¯ä»¥çœ‹åˆ°é¡¹ç›®è·¯å¾„ä¸‹å¤šäº†ä¸‰ä¸ªæ–‡ä»¶(å¤¹):
	
	fastlane(æ–‡ä»¶å¤¹), åŒ…å«æ–‡ä»¶:Appfile, Fastfile
	
	Gemfile
	
	Gemfile.lock
	
	å¦‚æœé€‰æ‹© 3 çš„è¯, éœ€è¦å…ˆè¾“å…¥è‹¹æœå¼€å‘å¼€å‘è€…è´¦å·å¯†ç , ç„¶åä¼šè‡ªåŠ¨ä¸‹è½½Appå…ƒæ•°æ®ç­‰ä¿¡æ¯, æˆ‘ä»¬é€‰æ‹© 4 å¯ä»¥åç»­å†ç›¸å…³é…ç½®æ–‡ä»¶ä¸­è¡¥ä¸Š, å¹¶ä¸”é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶è¾¾åˆ°å¤štargetæ”¯æŒ
	
4. ç¼–è¾‘ fastlane ç›¸å…³file
	
	1. æ–°å»º .env æ–‡ä»¶
	
		æ–‡ä»¶å‘½åæ ¼å¼: .env.targetName(é¡¹ç›®ä¸­æ¯ä¸ªtargetçš„åå­—), è¯¥æ–‡ä»¶é»˜è®¤ä¸ºç³»ç»Ÿéšè—æ–‡ä»¶, éœ€è¦å°†å…¶æ˜¾ç¤º
		
		ä½œç”¨: æä¾›åç»­ä¸€äº›å‚æ•°é…ç½®, ä¸åŒ .env æ–‡ä»¶å¯ä¸ºä¸åŒtargetæä¾›ä¸åŒå‚æ•°
		
		ä¸‹å›¾ fastlaneTest å’Œ fastlaneTest2 åˆ†åˆ«ä¸ºä¸¤ä¸ªtarget
		
		![files](https://raw.githubusercontent.com/lingjye/lingjye.github.io/master/img/fastlane/fastlane_files.png)
		
		ç¼–è¾‘ .env file:
		
		```
		# APPå”¯ä¸€æ ‡è¯†ç¬¦
		APP_IDENTIFIER = "é¡¹ç›® bundleID"
		# å‘å¸ƒç‰ˆæœ¬å· å¯æ ¹æ®Xcodeè·å–
		# APP_VERSION_RELEASE = "1.0.0"
		
		# æ–°ç‰ˆæœ¬ä¿®æ”¹è®°å½•
		RELEASE_NOTES = "1) å¢åŠ äº†ä¸€äº›åŠŸèƒ½\n2) ä¿®å¤äº†ä¸€äº›BUG"
		
		# è’²å…¬è‹± æ›´æ–°æè¿°
		# FIR_UPDATE_DESCRIPTION = "1) å¢åŠ äº†ä¸€äº›åŠŸèƒ½\n2) ä¿®å¤äº†ä¸€äº›BUG"
		
		# è‡ªåŠ¨æäº¤å®¡æ ¸
		SUBMIT_FOR_REVIEW = false
		
		# å®¡æ ¸é€šè¿‡åç«‹åˆ»å‘å¸ƒ
		AUTOMATIC_RELEASE = false
		
		# è‹¹æœå¼€å‘è€…è´¦å·
		APPLE_ID = "Your Apple ID"
		
		# è‹¹æœå¼€å‘è€…å¸å·å¯†ç 
		FASTLANE_PASSWORD = "Your Apple ID Password"
		
		# å¥—è£…ID å¯ç™»å½• developer.apple.com æŸ¥çœ‹
		TEAM_ID = "your_team_id"
		
		# åº”ç”¨targetåç§°
		SCHEME_NAME = "Target Name"
		
		# APPå…ƒæ•°æ®åŠæˆªå›¾å­˜æ”¾è·¯å¾„ é»˜è®¤ä¼šåœ¨fastlaneç›®å½•ä¸‹æ–°å»ºmetadataæ–‡ä»¶å¤¹, ä¸åŒtargetçš„å…ƒæ•°æ®éƒ½æ”¾åœ¨æ­¤è·¯å¾„ä¸‹, 
		METADATA_PATH = "./metadata/fastlaneTest(è‡ªå®šä¹‰çš„è·¯å¾„)"
		SCREENSHOTS_PATH = "./screenshots/fastlaneTest(è‡ªå®šä¹‰çš„è·¯å¾„)"
		
		# APPå…ƒæ•°æ®åŠæˆªå›¾ä¸‹è½½æ—¶ï¼Œç›´æ¥è¦†ç›–åŸæœ‰æ•°æ®ï¼Œä¸è¯¢é—®
		DELIVER_FORCE_OVERWRITE = true
		```
		
		å¤šä¸ªtargetå‚è€ƒ:
		
		![env](https://raw.githubusercontent.com/lingjye/lingjye.github.io/master/img/fastlane/fastlane_env.png)
	
	2. ç¼–è¾‘ Appfile
	
		æ‰¾åˆ°é¡¹ç›®è·¯å¾„ä¸‹çš„fastlaneæ–‡ä»¶å¤¹, æ‰“å¼€Appfile, ç¼–è¾‘å†…å®¹:
		
		```
		app_identifier ENV['APP_IDENTIFIER'] 
		apple_id ENV['APPLE_ID']
		team_id ENV['TEAM_ID'] 
		```
	
	3. ç¼–è¾‘ Deliverfile

		åœ¨fastlaneç›®å½•ä¸‹, æ–°å»ºæ–‡ä»¶åä¸ºDeliverfile, è¯¥æ–‡ä»¶ä¸AppfileåŒçº§
		
		ç¼–è¾‘å†…å®¹:
		
		```
		# The Deliverfile allows you to store various App Store Connect metadata
		# For more information, check out the docs
		# https://docs.fastlane.tools/actions/deliver/
		# The bundle identifier of your app
		app_identifier ENV['APP_IDENTIFIER'] 
		# your Apple ID user
		username ENV['APPLE_ID'] 
		
		# å…ƒæ•°æ®çš„è·¯å¾„
		metadata_path ENV['METADATA_PATH']
		screenshots_path ENV['SCREENSHOTS_PATH']
		
		 #App store ä¸­å¾…å‘å¸ƒçš„ App ç‰ˆæœ¬ï¼Œè‹¥æ¯ä¸ª target çš„ç‰ˆæœ¬å·ä¸åŒï¼Œå¯ä»¥é€šè¿‡.env æ–‡ä»¶æ¥åˆ†åˆ«å®šä¹‰
		 # app_version ENV['APP_VERSION_RELEASE']
		
		 #ä¸‹è½½ metadata åŠ screenshots æ—¶ç›´æ¥è¦†ç›–ï¼Œä¸è¯¢é—®
		 force true
		
		 #ä¸è¦†ç›– iTunes ConnectåŸæœ‰æˆªå›¾
		 skip_screenshots true
		    
		 #è‡ªåŠ¨æäº¤å®¡æ ¸
		 submit_for_review ENV['SUBMIT_FOR_REVIEW']
		  
		 #å®¡æ ¸é€šè¿‡åç«‹åˆ»å‘å¸ƒ
		 automatic_release ENV['AUTOMATIC_RELEASE']
		
		 #æ–°ç‰ˆæœ¬ä¿®æ”¹è®°å½•
		 release_notes({        
		    "zh-Hans" => ENV['RELEASE_NOTES']
		 })
		
		#App åŠ å¯†ç®—æ³•ä½¿ç”¨æƒ…å†µåŠå¹¿å‘Šç›¸å…³é…ç½®
		submission_information({
		    #Export Compliance
		    export_compliance_available_on_french_store: "false",
		    export_compliance_contains_proprietary_cryptography: "false",
		    export_compliance_contains_third_party_cryptography: "false",
		    export_compliance_is_exempt: "false",
		    export_compliance_uses_encryption: "false",
		    export_compliance_app_type: nil,
		    export_compliance_encryption_updated: "false",
		    export_compliance_compliance_required: "false",
		    export_compliance_platform: "ios",
		
		    content_rights_contains_third_party_content: "false",
		    content_rights_has_rights: "false",
		
		    #Advertising Identifier
		    add_id_info_limits_tracking: "false",
		    add_id_info_serves_ads: "false",
		    add_id_info_tracks_action: "false",
		    add_id_info_tracks_install: "false",
		    add_id_info_uses_idfa: "false"
		});
		```
		
		ç»“åˆ .env æ–‡ä»¶, ä¸éš¾ç†è§£ Appfile å’Œ Deliverfile ä¸­çš„å†…å®¹
	
	4. ç¼–è¾‘ Fastfile

		åœ¨fastlaneç›®å½•ä¸‹, æ‰“å¼€Fastfile, ç¼–è¾‘å†…å®¹:
		
		```
		default_platform(:ios)
		
		platform :ios do
		
		  desc "å‘å¸ƒappåˆ° App Store æˆ–è€… Fir.im "
		  lane :your_lane_task_name do
		    # add actions here: https://docs.fastlane.tools/actions
			sh "fastlane release(æ‰“åŒ…ç±»å‹æˆ–è€…adhoc) --env target_name"
		  end
		  
		  desc "å‘å¸ƒæŒ‡å®šTargetåˆ° Fir.im"
		  lane adhoc do
		  gym(
			clean:true, #æ‰“åŒ…å‰cleané¡¹ç›®
		    workspace: "MK100.xcworkspace",
			export_method: "ad-hoc", #å¯¼å‡ºæ–¹å¼
			scheme: ENV['SCHEME_NAME'], #scheme
		    output_name: ENV['SCHEME_NAME']+".ipa", # ipa æ–‡ä»¶å
			output_directory: "./ipa", #ipaçš„å­˜æ”¾ç›®å½•
			export_options: {
				provisioningProfiles: {
					"com.txooo.mk100"=>"MK100_Hoc", 
					"com.txooo.sumall"=>"SuMall_Hoc",
					"com.txooo.hechang"=>"Hechang_Hoc",
					"com.txooo.huikelianhua"=>"Hoc_huikelianhua",
					"com.txooo.sumall"=>"SuMall_Hoc"
				}
			}
		  )
		  # å‰å¾€fir.imè·å– api token, å°†é¼ æ ‡æ”¾ç½®å³ä¸Šè§’è´¦å·ä¸Šé¢, åœ¨ä¸‹æ‹‰çª—é€‰æ‹©API token
		  # è‹¥ä½¿ç”¨çš„è’²å…¬è‹±, è¯·å‰å¾€ https://www.pgyer.com/ æŸ¥çœ‹ä¸Šä¼ æ–¹æ³•
		  firim(firim_api_token:'ä½ çš„firim_api_token')
		  end
		  
		  desc "å‘å¸ƒæŒ‡å®šTargetåˆ° App Store"
		  lane : release do
		  gym(
			clean:true, #æ‰“åŒ…å‰cleané¡¹ç›®
			workspace: "MK100.xcworkspace",
			export_method: "app-store", #å¯¼å‡ºæ–¹å¼
			scheme: ENV['SCHEME_NAME'], #scheme
			output_name: ENV['SCHEME_NAME']+".ipa", # ipa æ–‡ä»¶å
			output_directory: "./ipa", #ipaçš„å­˜æ”¾ç›®å½•
		  )
		  deliver
		  end
			
		end
	
		```
		
		å¦‚å›¾:
		
		![fastfile](https://raw.githubusercontent.com/lingjye/lingjye.github.io/master/img/fastlane/fastlane_fastfile.png)
		
		æ³¨æ„: å¦‚æœä½¿ç”¨CocoaPod, åœ¨gymå‘½ä»¤ä¸‹çš„workspaceå¿…é¡»è®¾ç½®
	
5. å‘å¸ƒåº”ç”¨
	
		åœ¨ç»ˆç«¯è¾“å…¥fastlane, é€‰æ‹©å¯¹åº”çš„å‘å¸ƒç‰ˆæœ¬å³å¯
		
		![run](https://raw.githubusercontent.com/lingjye/lingjye.github.io/master/img/fastlane/fastlane_fastfile.png)

---

## ä½¿ç”¨é’‰é’‰æœºå™¨äººè¿›è¡Œæ¶ˆæ¯é€šçŸ¥

è®¾ç½®é’‰é’‰WebHook

> ç™»å½•é’‰é’‰, é€‰æ‹©å¯¹åº”ç¾¤èŠ, ç‚¹å‡»å³ä¸Šæ–¹'Â·Â·Â·'é€‰é¡¹, æ‰“å¼€ç¾¤è®¾ç½®;<br/>
> æ‰¾åˆ°ç¾¤æœºå™¨äºº, ç‚¹å¼€é€‰æ‹©æ·»åŠ æœºå™¨äºº, åœ¨å¯¹åº”ç¾¤æœºå™¨äººåˆ—è¡¨ä¸­å¯èƒ½æ‰¾ä¸åˆ°fir.im, æ­¤æ—¶é€‰æ‹©è‡ªå®šä¹‰, æŒ‰æç¤ºæ·»åŠ , è¾“å…¥è‡ªå®šä¹‰æœºå™¨äººåå­—(æœ€å¥½èƒ½ä½“ç°åŠŸèƒ½), å¯é€‰æ‹©ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ, æ¥å—æ¶ˆæ¯çš„è®¨è®ºç»„(é»˜è®¤å½“å‰ç¾¤ç»„)

![dingtalk](https://raw.githubusercontent.com/lingjye/lingjye.github.io/master/img/fastlane/dingtalk.png)

> ç‚¹å‡»å®Œæˆåä¼šçœ‹åˆ°webhooké¡µé¢, ç‚¹å‡»å¤åˆ¶

![dingtalk](http://img01.taobaocdn.com/top/i1/LB1lIUlPFXXXXbGXFXXXXXXXXXX#align=left&display=inline&height=294&originHeight=1372&originWidth=2088&status=done&width=447)

> å‰å¾€fir.im"åº”ç”¨ç®¡ç†", é€‰æ‹©å¯¹åº”çš„åº”ç”¨, é€‰æ‹©åº”ç”¨å›¾æ ‡å³ä¾§"é›†æˆ"é€‰é¡¹, æ‰¾åˆ°"é’‰é’‰"

![dingtalk](https://raw.githubusercontent.com/lingjye/lingjye.github.io/master/img/fastlane/firim-webhook.png)

> ç‚¹å‡»"+"å·, è¾“å…¥é…ç½®åç§°, å¹¶å°†é’‰é’‰ä¸­çš„webhookåœ°å€ç²˜è´´äºæ­¤å¤„å¹¶æ·»åŠ 

æµ‹è¯•é’‰é’‰æœºå™¨äºº:

1. ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·curl

	```
	curl 'https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxx' \
	   -H 'Content-Type: application/json' \
	   -d '{"msgtype": "text", 
	        "text": {
	             "content": "æµ‹è¯•ä¸€ä¸‹"
	        }
	      }'
	```

2. ç›´æ¥ä¸Šä¼ ä¸€ä¸ªipaåˆ°fir.im

æ³¨æ„æŸ¥çœ‹é’‰é’‰ç¾¤èŠæ¶ˆæ¯

![dingtalk](https://raw.githubusercontent.com/lingjye/lingjye.github.io/master/img/fastlane/jiqiren.png)